# IOS.CoderService - æ¡ç æ‰«ææœåŠ¡

## æ¦‚è¿°

IOS.CoderServiceæ˜¯æ™ºèƒ½å‡ºåº“ç³»ç»Ÿä¸­çš„æ¡ç æ‰«ææœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†å’Œåè°ƒå¤šä¸ªæ¡ç æ‰«æå®¢æˆ·ç«¯ï¼Œé€šè¿‡Socketé€šä¿¡æ”¶é›†æ¡ç æ•°æ®ï¼Œå¹¶é€šè¿‡MQTTæ¶ˆæ¯æ€»çº¿ä¸å…¶ä»–ç³»ç»Ÿç»„ä»¶è¿›è¡Œé›†æˆã€‚è¯¥æœåŠ¡åŸºäº.NET 8æ„å»ºï¼Œé›†æˆäº†SocketæœåŠ¡å™¨ã€MQTTé€šä¿¡å’ŒRESTful APIåŠŸèƒ½ã€‚

## ä¸»è¦åŠŸèƒ½

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
- **SocketæœåŠ¡å™¨**ï¼šç›‘å¬TCPè¿æ¥ï¼Œæ¥æ”¶å¤šä¸ªå®¢æˆ·ç«¯çš„æ¡ç æ‰«ææ•°æ®
- **MQTTé›†æˆ**ï¼šé€šè¿‡MQTTæ¥æ”¶æ‰«ç å‘½ä»¤å’Œå‘å¸ƒæ¡ç æ•°æ®
- **RESTful API**ï¼šæä¾›HTTP APIè¿›è¡Œæ‰‹åŠ¨æ§åˆ¶å’ŒçŠ¶æ€æŸ¥è¯¢
- **å®¢æˆ·ç«¯ç®¡ç†**ï¼šç®¡ç†å¤šä¸ªæ‰«ç è®¾å¤‡è¿æ¥ï¼Œå®æ—¶ç›‘æ§è¿æ¥çŠ¶æ€
- **æ•°æ®èšåˆ**ï¼šæ”¶é›†å¹¶æ•´åˆæ¥è‡ªä¸åŒå®¢æˆ·ç«¯çš„æ¡ç æ•°æ®
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šç¼“å­˜å’Œç®¡ç†å®¢æˆ·ç«¯æ¶ˆæ¯

### ğŸ“¡ MQTTä¸»é¢˜

#### æ¥æ”¶ä¸»é¢˜ï¼ˆè®¢é˜…ï¼‰
- `coder/start` - å¯åŠ¨æ‰«ç ä»»åŠ¡
- `coder/config` - é…ç½®æŸ¥è¯¢
- `coder/stop` - åœæ­¢æ‰«ç ä»»åŠ¡
- `order` - è®¢å•ä¿¡æ¯

#### å‘é€ä¸»é¢˜ï¼ˆå‘å¸ƒï¼‰
- `coder/odoo` - æ¡ç æ•°æ®ï¼ˆå‘é€ç»™ä¸šåŠ¡ç³»ç»Ÿï¼‰
- `get_order` - è·å–è®¢å•è¯·æ±‚
- `coder/status` - çŠ¶æ€ä¿¡æ¯

### ğŸ”§ APIç«¯ç‚¹

- `GET /api/coder/status` - è·å–æœåŠ¡çŠ¶æ€
- `GET /api/coder/clients` - è·å–è¿æ¥çš„å®¢æˆ·ç«¯åˆ—è¡¨
- `POST /api/coder/start-scanning` - å¯åŠ¨æ‰«ç ä»»åŠ¡
- `POST /api/coder/collect-codes` - æ”¶é›†æ¡ç æ•°æ®
- `DELETE /api/coder/clients/{endPoint}` - æ–­å¼€æŒ‡å®šå®¢æˆ·ç«¯
- `POST /api/coder/clear-queue` - æ¸…ç©ºæ¶ˆæ¯é˜Ÿåˆ—
- `POST /api/coder/clients/{endPoint}/send` - å‘é€æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯
- `POST /api/coder/broadcast` - å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
- `POST /api/coder/start` - å¯åŠ¨æœåŠ¡
- `POST /api/coder/stop` - åœæ­¢æœåŠ¡

## é…ç½®è¯´æ˜

### appsettings.json

```json
{
  "CoderService": {
    "SocketAddress": "0.0.0.0",     // Socketç›‘å¬åœ°å€
    "SocketPort": 5000,             // Socketç›‘å¬ç«¯å£
    "MaxClients": 10,               // æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°
    "ReceiveBufferSize": 1024,      // æ¥æ”¶ç¼“å†²åŒºå¤§å°
    "ClientTimeout": 30000,         // å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    "Topics": {
      "Receives": {
        "Start": "coder/start",
        "Config": "coder/config",
        "Stop": "coder/stop",
        "Order": "order"
      },
      "Sends": {
        "Coder": "coder/odoo",
        "Order": "get_order",
        "Status": "coder/status"
      }
    }
  }
}
```

## å·¥ä½œæµç¨‹

### æ‰«ç ä»»åŠ¡æµç¨‹
1. **æ¥æ”¶å¯åŠ¨å‘½ä»¤**ï¼šé€šè¿‡MQTTæ¥æ”¶`coder/start`æ¶ˆæ¯ï¼ŒåŒ…å«æ–¹å‘å’Œå †å é«˜åº¦ä¿¡æ¯
2. **å‡†å¤‡æ‰«ç **ï¼šæ¸…ç©ºä¹‹å‰çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå»¶è¿Ÿ500msç­‰å¾…å®¢æˆ·ç«¯å‡†å¤‡
3. **æ”¶é›†æ•°æ®**ï¼šç­‰å¾…5ç§’æ”¶é›†æ‰€æœ‰è¿æ¥å®¢æˆ·ç«¯çš„æ¡ç æ•°æ®
4. **è¯·æ±‚è®¢å•**ï¼šå‘å¸ƒ`get_order`æ¶ˆæ¯è¯·æ±‚è®¢å•ä¿¡æ¯
5. **æ¥æ”¶è®¢å•**ï¼šé€šè¿‡`order`ä¸»é¢˜æ¥æ”¶è®¢å•å·
6. **å‘å¸ƒç»“æœ**ï¼šå°†å®Œæ•´çš„æ¡ç ä¿¡æ¯å‘å¸ƒåˆ°`coder/odoo`ä¸»é¢˜

### æ¶ˆæ¯æ ¼å¼

#### å¯åŠ¨æ‰«ç æ¶ˆæ¯æ ¼å¼
```
{direction};{stackHeight}
```
ç¤ºä¾‹ï¼š`å…¥åº“;150.5`

#### æ¡ç æ•°æ®æ ¼å¼
```json
{
  "messageId": "uuid",
  "timestamp": "2024-01-01T00:00:00Z",
  "source": "CoderService",
  "messageType": "Response",
  "data": {
    "order": "ORDER123",
    "codes": "CODE1;CODE2;CODE3",
    "direction": "å…¥åº“",
    "stackHeight": 150.5,
    "timestamp": "2024-01-01T00:00:00Z"
  }
}
```

#### å®¢æˆ·ç«¯çŠ¶æ€æ ¼å¼
```json
{
  "isRunning": true,
  "connectedClients": 3,
  "listenAddress": "0.0.0.0",
  "listenPort": 5000,
  "mqttConnected": true,
  "timestamp": "2024-01-01T00:00:00Z"
}
```

## å®¢æˆ·ç«¯é›†æˆ

### Socketå®¢æˆ·ç«¯è¦æ±‚
- **åè®®**ï¼šTCP
- **ç¼–ç **ï¼šUTF-8
- **è¿æ¥æ–¹å¼**ï¼šä¸»åŠ¨è¿æ¥åˆ°æœåŠ¡å™¨
- **æ•°æ®æ ¼å¼**ï¼šçº¯æ–‡æœ¬ï¼Œæ¯ä¸ªæ¡ç ä¸€æ¡æ¶ˆæ¯

### å®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹ï¼ˆC#ï¼‰
```csharp
using var client = new TcpClient();
await client.ConnectAsync("192.168.1.100", 5000);
using var stream = client.GetStream();

// å‘é€æ¡ç æ•°æ®
var message = "12345678901234";
var buffer = Encoding.UTF8.GetBytes(message);
await stream.WriteAsync(buffer);
```

### å®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹ï¼ˆPythonï¼‰
```python
import socket

client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect(('192.168.1.100', 5000))

# å‘é€æ¡ç æ•°æ®
message = "12345678901234"
client.send(message.encode('utf-8'))
client.close()
```

## è¿è¡Œè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- Windows 10/11 æˆ– Linux
- .NET 8 Runtime
- ç½‘ç»œè¿æ¥ï¼ˆç”¨äºMQTTå’ŒSocketé€šä¿¡ï¼‰

### ç½‘ç»œè¦æ±‚
- Socketç«¯å£ï¼ˆé»˜è®¤5000ï¼‰å¯è®¿é—®
- MQTTæœåŠ¡å™¨è¿æ¥æ­£å¸¸
- ä¸æ¡ç æ‰«æè®¾å¤‡çš„ç½‘ç»œè¿é€šæ€§

## å¯åŠ¨å’Œéƒ¨ç½²

### å¼€å‘ç¯å¢ƒè¿è¡Œ
```bash
cd intelligentoutboundsystem/src/Services/IOS.CoderService
dotnet run
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# å‘å¸ƒåº”ç”¨
dotnet publish -c Release -o ./publish

# WindowsæœåŠ¡å®‰è£…
sc create "IOS.CoderService" binPath="C:\path\to\publish\IOS.CoderService.exe"
sc start "IOS.CoderService"

# Linux systemdæœåŠ¡
sudo systemctl enable ios-coderservice.service
sudo systemctl start ios-coderservice.service
```

## æ—¥å¿—å’Œç›‘æ§

### æ—¥å¿—é…ç½®
- **æ§åˆ¶å°è¾“å‡º**ï¼šå¼€å‘ç¯å¢ƒå®æ—¶æŸ¥çœ‹
- **æ–‡ä»¶æ—¥å¿—**ï¼šç”Ÿäº§ç¯å¢ƒä¿å­˜åœ¨`logs/coder-service-{date}.log`

### ç›‘æ§æŒ‡æ ‡
- è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡
- æ¶ˆæ¯å¤„ç†é€Ÿåº¦
- é”™è¯¯ç‡å’Œå“åº”æ—¶é—´
- MQTTè¿æ¥çŠ¶æ€

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Socketè¿æ¥å¤±è´¥**
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
   - éªŒè¯é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤å®¢æˆ·ç«¯ç½‘ç»œè¿æ¥

2. **MQTTè¿æ¥å¤±è´¥**
   - æ£€æŸ¥MQTTæœåŠ¡å™¨åœ°å€å’Œç«¯å£
   - éªŒè¯è®¤è¯ä¿¡æ¯
   - æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€

3. **å®¢æˆ·ç«¯æ•°æ®ä¸¢å¤±**
   - æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§
   - å¢åŠ è¶…æ—¶æ—¶é—´é…ç½®
   - æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

### è°ƒè¯•æŠ€å·§
- ä½¿ç”¨APIç«¯ç‚¹æ£€æŸ¥æœåŠ¡çŠ¶æ€
- é€šè¿‡æ—¥å¿—è¿½è¸ªæ¶ˆæ¯æµ
- ä½¿ç”¨MQTTå®¢æˆ·ç«¯å·¥å…·æµ‹è¯•æ¶ˆæ¯
- æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥åˆ—è¡¨

## æ€§èƒ½ä¼˜åŒ–

### é…ç½®å»ºè®®
- æ ¹æ®å®¢æˆ·ç«¯æ•°é‡è°ƒæ•´`MaxClients`
- æ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´`ClientTimeout`
- é€‚å½“è®¾ç½®`ReceiveBufferSize`

### æ‰©å±•æ€§è€ƒè™‘
- æ”¯æŒæ°´å¹³æ‰©å±•ï¼ˆå¤šå®ä¾‹éƒ¨ç½²ï¼‰
- è´Ÿè½½å‡è¡¡é…ç½®
- æ•°æ®åº“æŒä¹…åŒ–é€‰é¡¹

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°åŠŸèƒ½
1. åœ¨`ICoderService`æ¥å£ä¸­æ·»åŠ æ–°æ–¹æ³•
2. åœ¨`CoderService`ä¸­å®ç°å…·ä½“é€»è¾‘
3. åœ¨`CoderController`ä¸­æ·»åŠ å¯¹åº”çš„APIç«¯ç‚¹
4. åœ¨`CoderHostedService`ä¸­æ·»åŠ MQTTå¤„ç†é€»è¾‘

### æ”¯æŒæ–°çš„æ¶ˆæ¯æ ¼å¼
- æ‰©å±•`CodeInfo`æ¨¡å‹
- æ›´æ–°æ¶ˆæ¯åºåˆ—åŒ–é€»è¾‘
- ä¿®æ”¹APIå“åº”æ ¼å¼

## å®‰å…¨è€ƒè™‘

1. **ç½‘ç»œå®‰å…¨**ï¼šä½¿ç”¨VPNæˆ–ä¸“ç”¨ç½‘ç»œ
2. **è®¤è¯æˆæƒ**ï¼šAPIç«¯ç‚¹æ·»åŠ è®¤è¯
3. **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®ä¼ è¾“åŠ å¯†
4. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶å®¢æˆ·ç«¯IPèŒƒå›´

## ç‰ˆæœ¬å†å²

- **v1.0.0** - åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºæœ¬çš„SocketæœåŠ¡å™¨å’ŒMQTTé›†æˆ
- åŸºäºåŸå§‹CoderServiceé¡¹ç›®è¿ç§»ï¼Œé€‚é…IOSæ¶æ„ 